Import('env')

module_env = env.Clone()

# Base source files that always compile
base_sources = [
    "register_types.cpp",
    "thirdparty/flecs/distr/flecs.c",
    "ecs/flecs_types/flecs_query.cpp",
    "ecs/flecs_types/flecs_script_system.cpp",
    "ecs/systems/pipeline_manager.cpp",
    "ecs/systems/gdscript_runner_system.cpp",
    "ecs/systems/utility/navigation2d_utility.cpp",
    "ecs/systems/utility/navigation3d_utility.cpp",
    "ecs/systems/utility/physics2d_utility.cpp",
    "ecs/systems/utility/physics3d_utility.cpp",
    "ecs/systems/utility/render_utility_2d.cpp",
    "ecs/systems/utility/render_utility_3d.cpp",
    "ecs/systems/utility/resource_object_utility.cpp",
    "ecs/systems/utility/scene_object_utility.cpp",
    "ecs/systems/utility/world_utility.cpp",
    "ecs/systems/demo/bad_apple_system.cpp",
    "ecs/flecs_types/flecs_server.cpp",
    "runtime/flecs_runtime_debugger.cpp",
    # Network module
    "network/network_server.cpp",
]

# Editor-only source files (only compile when building the editor)
if env.editor_build:
    base_sources.extend([
        "editor/flecs_editor_plugin.cpp",
        "editor/flecs_entity_inspector.cpp",
        "editor/flecs_profiler.cpp",
        "editor/flecs_profiler_plugin.cpp",
        "editor/world_info.cpp",
        "editor/network_editor_plugin.cpp",
    ])

module_env.add_source_files(env.modules_sources, base_sources)

# Use env.GetModulePath() for the module's root, or env.Dir('.')
# Based on common Godot SCons practices, env.GetModulePath() is often available
# or directly using env.Dir('.') which refers to the current directory of the SCsub.

module_env.Append(CPPPATH=[
    # The current directory of this SCsub (i.e., godot_turbo/)
    env.Dir('.'), # This is the most robust and standard SCons way.

    # Specific third-party library relative to module root
    env.Dir('thirdparty/flecs/distr'),
    env.Dir('thirdparty/concurrentqueue/'),

    # Editor subdirectory
    env.Dir('editor'),

    # Main ECS subdirectories relative to module root
    env.Dir('ecs'),
    env.Dir('ecs/flecs_types'),
    env.Dir('ecs/components'),
    env.Dir('ecs/utility'),
    env.Dir('ecs/systems'),
    env.Dir('ecs/systems/utility'),
    env.Dir('runtime'),

    # Network module
    env.Dir('network'),
    env.Dir('network/components'),
    env.Dir('network/systems'),
])

# NOTE: No build-level override for concurrentqueue is applied by default here.
# If we need to force the mutex-fallback, define MCDBGQ_NOLOCKFREE_IMPLICITPRODHASH
# via CPPDEFINES here and provide a compatibility header. Keep the vendored header
# unchanged by default to attempt to reproduce earlier runtime behavior.

# Optional optimizations
# module_env.Append(CCFLAGS=["-O2"])
